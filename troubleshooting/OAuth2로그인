# OAuth2 로그인

## OAuth2 로그인 데이터 충돌

### 보고  
: OAuth2 회원가입, 데이터베이스에 Naver 플랫폼으로 로그인 요청 확인, 아이디도 네이버 아이디로 회원가입 되었다.  
하지만 메일 주소는 hanmail@net - 네이버아이디@카카오이메일, 요청 플랫폼은 네이버인 상황    
카카오로그인을 시도하였다가 실패하여서 다시 네이버로그인을 요청하였더니 해당 문제 발생하였다고 보고되었음  

### 추가 문제 확인
- 추가적인 발생이 없나 싶어서 데이터베이스를 살펴보니  
네이버 플랫폼으로 가입했는데 메일 주소가 @hanmail.net인 경우가 10건이상 확인되었다.  
(외 paran.com, hotmail.com, playhouse.com 등.. 카카오톡의 경우 이메일 주소가 다양하고, 충돌난 게 아닐까 싶다)
- 네이버로그인 요청하였으나 메일주소는 @gmail.com인 경우도 1건 확인
- 네이버의 경우 @naver.com 외에 다른 주소일 수 없다는 걸 확인

### 1차
- 문제가 생겼다고 문의한 유저의 경우 해당 네이버아이디@카카오이메일 주소를 네이버아이디@네이버이메일로 변경

### 제안
- 개인 개정으로는 해당 문제가 어떻게 발생하는지 알 수 없어서.. Oauth2 로그인 테스트 코드 작성
- OAuth2 api서버에 어떻게 요청하고 응답받는지 세부적인 학습 진행
- 테스트 코드로 해당 문제 재현

### 2차
- 전체 코드를 테스트하기엔 문제 재현하는 과정이 너무 복잡하여 다시 문제 원인이 무엇인지 짚어봄...
1. DTO에 static 으로 코드를 담다보니 겹치는 문제가 생겼다.  
  -> dhgpcks123@naver.com (네이버로그인), dhgpcks@gmail.com (카카오톡)이 원래 의도했던 것이라면  
  dhgpks123@naver.com (카카오톡), dhgpcks@gmail.com (네이버) 가 되어야 한다.
2. 데이터베이스에 정보가 담기다 꼬였다?  
  마찬가지로  
  -> dhgpcks123@naver.com (네이버로그인), dhgpcks@gmail.com (카카오톡)이 원래 의도했던 것이라면  
  데이터가 비었거나.. 다른 방식으로 꼬여야한다.
  
하지만 dhgpcks123@gmail.com (네이버로그인)이 어떻게 이렇게 데이터가 담길 수 있지?  
아무리 생각해도 불가능하다고 생각해서 좀 더 구글링을 했다

### 결과

이는 네이버 정책상 "연락처 이메일"만 제공하고 네이버 이메일(네이버ID@naver.com)은 제공하지 않기 때문이예요!
한때 네이버 아이디 로그인 서비스에서 네이버 계정 이메일을 제공한 적도 있으나,
현재는 정책이 변경되어서 더이상 네이버 계정 이메일을 제공하지 않아요. 

오늘의 교훈 : 문제가 발생할 수 있는 이유를 고민하고, 좁히고.. 좁은 부분에서부터 문제를 해결해나가야한다.
문제가 어디서 발생하는지 파악하기 위해 전 과정을 다시 테스트 하는 건 훨씬 어려운 일이다..

만약 메일링이 중요한 서비스였다면  
DB에 컬럼을 따로 둬서 소셜로그인으로 제공 받은 이메일 주소, 클라이언트가 입력한 이메일주소로 따로 관리하는 게 좋을 듯 하다.